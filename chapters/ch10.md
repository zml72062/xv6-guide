# 10. 内核态中断处理

本章和接下来的一章研究 xv6 中最有趣的主题之一: **内核态和用户态的切换**. 回忆一下, xv6 内核工作在 **S 模式**, 而用户进程工作在 **U 模式**. 而在 RISC-V 中, 导致处理器特权模式从 U (低级别) 切换到 S (高级别) 的唯一机制是 **中断**. 因此, 不难得出以下论断:
* 从用户态进入内核态, 意味着发生了 **中断**
* 从内核态回到用户态, 意味着 **中断返回**

> 第 3 章中讨论的时钟中断是一个特例. 甚至不能在 S 模式中处理时钟中断, 而必须进入 M 模式.

即使在内核态, 中断也有可能发生. 在本章中, 我们首先讨论 **内核态中发生中断** 该怎么处理. 这是因为处理用户态中产生的中断涉及 **从用户态到内核态的陷入**, 从而更加复杂. 后一种情况将是下一章的主题.

## RISC-V 硬件对中断的支持

和之前讨论过的虚拟内存机制一样, 中断处理离不开硬件的支持. 在第 2、3 章中, 我们已经初步介绍过 RISC-V 处理器在 **M 模式** 下会如何响应中断. 我们总结如下:
1. 处理器每执行完一条指令, 便检查是否需要响应中断. 只有以下三个条件同时满足, 才会响应中断:
    * `mstatus` 中的 MIE 位为 1
    * 对于中断码为 i 的外中断/内中断, `mideleg`/`medeleg` 的第 i 位为 0
    * 对于中断码为 i 的外中断, `mip` 和 `mie` 的第 i 位均为 1
    
    如果有中断要响应, 处理器可以根据 `mip` 判断中断的类型. (内中断还是外中断? 中断码是多少?)
2. 



