# 10. 内核态中断处理

本章和接下来的一章研究 xv6 中最有趣的主题之一: **内核态和用户态的切换**. 回忆一下, xv6 内核工作在 **S 模式**, 而用户进程工作在 **U 模式**. 我们知道, 在 RISC-V 中, 导致处理器特权模式从 U (低级别) 切换到 S (高级别) 的唯一机制是 **中断**. 因此, 不难得出以下论断:
* 从用户态进入内核态, 意味着发生了 **中断**
* 从内核态回到用户态, 意味着 **中断返回**

> 第 3 章中讨论的时钟中断是一个特例. 甚至不能在 S 模式中处理时钟中断, 而必须进入 M 模式.

即使在内核态, 中断也有可能发生. 在本章中, 我们首先讨论 **内核态中发生中断** 该怎么处理. 这是因为处理用户态中产生的中断涉及 **从用户态到内核态的陷入**, 从而更加复杂. 后一种情况将是下一章的主题.

## RISC-V 硬件对中断的支持

和之前讨论过的虚拟内存机制一样, 中断处理离不开硬件的支持. 在第 2、3 章中, 我们已经初步介绍过 RISC-V 处理器响应中断的过程. 在这里, 我们给出一个更加正式、完整的描述. 我们假设处理器一开始处于 S 或 U 模式.

1. 处理器每执行完一条指令, 便检查是否需要响应中断. 处理器会对每一类中断作如下检查:
    * 如果该中断是 **内中断** (即指令本身产生的中断) 且中断码为 i, 那么检查 `medeleg` 的第 i 位. 根据这一位为 0 或为 1, 处理器决定陷入 **M 模式** 或 **S 模式** 以处理中断.
    * 如果该中断是 **外中断** (外部设备产生的中断) 且中断码为 i, 那么
        + 首先检查 `mideleg` 的第 i 位. 根据这一位为 0 或为 1, 处理器判断该中断的级别为 **M 级别** 或 **S 级别**. 
            > 此时处理器还不一定决定 **响应中断**, 因为还需检查中断开关.
        + 根据中断的级别为 M/S, 确认 `mstatus`/`sstatus` 中的 MIE/SIE 位为 1, 且 `mie`/`sie` 的第 i 位为 1. 如果两个位都为 1, 说明 **中断开关** 处于开启, 执行下一步; 否则, 不响应中断.
        + 检查 `mip`/`sip` 的第 i 位. 如果为 1, 说明有中断待处理; 根据中断的级别为 M/S, 处理器决定陷入 **M 模式** 或 **S 模式** 以处理中断. 否则, 不响应中断.

        如果确实有待处理的外中断, 则处理器可以通过 `mip`/`sip` 中为 1 的位确定其类型.

假定在第 1 步中, 处理器 **决定陷入 X 模式** (X 为 M/S) 处理中断. 那么处理器接下来就完成一些例行公事: 

2. 将当前处理器特权级别存入 `xstatus` 寄存器的 XPP 字段, 然后将特权级别切换为 X.
3. 将 `xstatus` 中的 XIE 位保存到 XPIE 位, 然后令 XIE 位为 0. 这样, 我们在 X 模式下 **关闭所有外中断**.
4. 填写 `xcause` 寄存器. 该寄存器用于向软件 (操作系统) 报告中断原因.
    * 对于外中断/内中断, `xcause` 的最高位分别填 1/0.
    * `xcause` 的剩余位填入中断码.
5. 把当前 `pc` 存入 `xepc` 寄存器.
6. 把 `xtvec` 寄存器的值复制到 `pc`.
> 这里我们假设 `mtvec`/`stvec` 中存有 4 字节对齐的地址. RISC-V 还允许在第 6 步中根据不同的中断码将 `pc` 设置为不同的地址, 但是 xv6 不使用这一特性.

在这里, 5、6 两步合称为 **交换中断向量**. 等到处理器做完上面的全部工作后, 



